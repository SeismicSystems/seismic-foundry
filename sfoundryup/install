#!/usr/bin/env bash
set -eo pipefail

echo "Installing sfoundryup..."

# Default to devs mode
SEISMIC_MODE="devs"

# Parse command-line arguments
while [[ -n $1 ]]; do
  case $1 in
    --seismic-core)  SEISMIC_MODE="core";;
    --seismic-devs)  SEISMIC_MODE="devs";;
  esac
  shift
done

# Ensure SEISMIC_PAT is set if not using seismic-core
if [[ -z "$SEISMIC_PAT" && "$SEISMIC_MODE" != "core" ]]; then
  echo "Error: SEISMIC_PAT environment variable is not set. Please export it with your GitHub Personal Access Token."
  echo "Example: export SEISMIC_PAT=your_personal_access_token"
  exit 1
fi

# Define paths consistent with sfoundryup
BASE_DIR="${XDG_CONFIG_HOME:-$HOME}"
SEISMIC_DIR="${SEISMIC_DIR:-"$BASE_DIR/.seismic"}"
SEISMIC_BIN_DIR="$SEISMIC_DIR/bin"

BIN_PATH="$SEISMIC_BIN_DIR/sfoundryup"

# Create necessary directories
mkdir -p "$SEISMIC_BIN_DIR"

# Download sfoundryup using the appropriate method
echo "Fetching sfoundryup from the private repository..."
if [[ "$SEISMIC_MODE" == "core" ]]; then
  # Use SSH for core
  scp git@github.com:SeismicSystems/seismic-foundry/sfoundryup/sfoundryup "$BIN_PATH"
else
  # Use PAT for devs
  curl -sSf -H "Authorization: token $SEISMIC_PAT" \
       "https://raw.githubusercontent.com/SeismicSystems/seismic-foundry/ameya/conditional-sfoundryup/sfoundryup/sfoundryup" -o "$BIN_PATH"
fi

# Make the file executable
chmod +x "$BIN_PATH"

# Update the PATH environment variable
case $SHELL in
*/zsh)
    PROFILE="${ZDOTDIR:-$HOME}/.zshenv"
    ;;
*/bash)
    PROFILE="$HOME/.bashrc"
    ;;
*/fish)
    PROFILE="$HOME/.config/fish/config.fish"
    ;;
*/ash)
    PROFILE="$HOME/.profile"
    ;;
*)
    echo "Could not detect shell. Please manually add $SEISMIC_BIN_DIR to your PATH."
    exit 1
esac

if [[ ":$PATH:" != *":$SEISMIC_BIN_DIR:"* ]]; then
    if [[ "$SHELL" == *fish ]]; then
        echo >> "$PROFILE" && echo "fish_add_path $SEISMIC_BIN_DIR" >> "$PROFILE"
    else
        echo >> "$PROFILE" && echo "export PATH=\"\$PATH:$SEISMIC_BIN_DIR\"" >> "$PROFILE"
    fi
fi

# Ensure prerequisites are installed
echo "Checking prerequisites..."
for cmd in git curl; do
    if ! command -v "$cmd" >/dev/null; then
        echo "Error: $cmd is required but not installed. Please install it and re-run this script."
        exit 1
    fi
done

# Print completion message
echo
echo "sfoundryup installed successfully at $SEISMIC_BIN_DIR/sfoundryup."
echo "Run 'source $PROFILE' or start a new terminal session to use sfoundryup."
echo "Then, run 'sfoundryup' to install Seismic Foundry tools."
