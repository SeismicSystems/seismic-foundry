#!/usr/bin/env bash
set -eo pipefail

echo "Installing sfoundryup..."

# Define paths consistent with sfoundryup
BASE_DIR="${XDG_CONFIG_HOME:-$HOME}"
SEISMIC_DIR="${SEISMIC_DIR:-"$BASE_DIR/.seismic"}"
SEISMIC_BIN_DIR="$SEISMIC_DIR/bin"
SEISMIC_MAN_DIR="$SEISMIC_DIR/share/man/man1"

BIN_PATH="$SEISMIC_BIN_DIR/sfoundryup"

# Ensure SEISMIC_PAT is set
if [[ -z "$SEISMIC_PAT" ]]; then
  echo "Error: SEISMIC_PAT environment variable is not set. Please export it with your GitHub Personal Access Token."
  echo "Example: export SEISMIC_PAT=your_personal_access_token"
  exit 1
fi

# GitHub API URL to sfoundryup in the private repository
RAW_API_URL="https://api.github.com/repos/SeismicSystems/seismic-foundry/contents/sfoundryup?ref=ameya/local-solc"

# Create necessary directories
mkdir -p "$SEISMIC_BIN_DIR"
mkdir -p "$SEISMIC_MAN_DIR"

# Download sfoundryup using GitHub API
echo "Fetching sfoundryup from the private repository..."
curl -sSf -H "Authorization: token $SEISMIC_PAT" \
     -H "Accept: application/vnd.github.v3.raw" \
     "$RAW_API_URL" -o "$BIN_PATH"
chmod +x "$BIN_PATH"

# Update the PATH environment variable
case $SHELL in
*/zsh)
    PROFILE="${ZDOTDIR:-$HOME}/.zshenv"
    ;;
*/bash)
    PROFILE="$HOME/.bashrc"
    ;;
*/fish)
    PROFILE="$HOME/.config/fish/config.fish"
    ;;
*/ash)
    PROFILE="$HOME/.profile"
    ;;
*)
    echo "Could not detect shell. Please manually add $SEISMIC_BIN_DIR to your PATH."
    exit 1
esac

if [[ ":$PATH:" != *":$SEISMIC_BIN_DIR:"* ]]; then
    if [[ "$SHELL" == *fish ]]; then
        echo >> "$PROFILE" && echo "fish_add_path $SEISMIC_BIN_DIR" >> "$PROFILE"
    else
        echo >> "$PROFILE" && echo "export PATH=\"\$PATH:$SEISMIC_BIN_DIR\"" >> "$PROFILE"
    fi
fi

# Ensure prerequisites are installed
echo "Checking prerequisites..."
for cmd in git curl jq; do
    if ! command -v "$cmd" >/dev/null; then
        echo "Error: $cmd is required but not installed. Please install it and re-run this script."
        exit 1
    fi
done

# Warn MacOS users about libusb
if [[ "$OSTYPE" == "darwin"* ]] && [[ ! -f /usr/local/opt/libusb/lib/libusb-1.0.0.dylib && ! -f /opt/homebrew/opt/libusb/lib/libusb-1.0.0.dylib ]]; then
    echo
    echo "Warning: libusb not found. You may need to install it manually on MacOS via Homebrew (brew install libusb)."
fi

# Print completion message
echo
echo "sfoundryup installed successfully at $SEISMIC_BIN_DIR/sfoundryup."
echo "Run 'source $PROFILE' or start a new terminal session to use sfoundryup."
echo "Then, run 'sfoundryup' to install Seismic Foundry tools."
